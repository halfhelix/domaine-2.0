---
import type { SanityAsset } from '@sanity/image-url/lib/types/types';
import { urlFor } from '../../utils/sanityClient';

interface Props {
  image: { 
    asset: {
      _id: 'string',
      metadata: {
        dimensions: {
          width: number,
          height: number,
          aspectRatio: number,
        },
        blurHash: string
      }
    },
    crop: {
      top: number,
      right: number,
      bottom: number,
      left: number
    },
    alt: string
  },
  sizes: string,
  eager?: boolean,
  aspectRatio?: number,
  alt?: string,
}

const { image, sizes, eager, aspectRatio, alt } = Astro.props;

const srcWidth = image.asset.metadata.dimensions.width;
const srcHeight = image.asset.metadata.dimensions.height;

const crop = image.crop
const cropTop = crop ? crop.top : 0
const cropRight = crop ? crop.right : 0
const cropBottom = crop ? crop.bottom : 0
const cropLeft = crop ? crop.left : 0

const width = srcWidth - (srcWidth * cropLeft) - (srcWidth * cropRight)
const height = srcHeight - (srcHeight * cropTop) - (srcHeight * cropBottom)
const ratio = aspectRatio ? aspectRatio : width / height

const generateSrcSets = () => {
  const sources = []
  for (let i = 1; i <=6; i+= 0.5) {
    sources.push( `${urlFor(image).width(Math.floor(width / i)).height(Math.floor((width / i) / ratio )).auto('format').url()} ${Math.floor(width / i)}w`)
  }
  return sources.toString()
}

const blurHash = image.asset.metadata.blurHash
// console.log(image.asset.metadata)
// console.log(blurHash)


// console.log(image)
// console.log(generateSrcSets())
---
<img
  id={image.asset._id}
  class="sanity-image"
  width={width}
  height={height}
  sizes={sizes}
  srcset={generateSrcSets()}
  src={urlFor(image).width(width).height(height).auto('format').url()}
  decoding={eager ? 'sync' : 'async'}
  loading={eager ? 'eager' : 'lazy'}
  alt={alt ? alt : image.alt}
  data-width={width}
  data-height={height}
  data-blur-hash = {blurHash}
/>

<!-- <script >
  import { decode } from "blurhash";

  const resolution = 32

  const images = document.querySelectorAll('.sanity-image')

  images.forEach((image: HTMLElement) => {

    const boundingBox = image.getBoundingClientRect()
    // console.log(boundingBox)

    const blurHash = image.dataset.blurHash

    const pixels = decode(blurHash, resolution, resolution);
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const imageData = ctx.createImageData(image.dataset.width, image.dataset.height);
    imageData.data.set(pixels);
    ctx.putImageData(imageData, 0, 0);
    const blurredImageUrl = canvas.toDataURL();
    console.log(blurredImageUrl)
    document.body.append(canvas);
  })



</script> -->

<style>
  .sanity-image {
    display: block;
    width: 100%;
    height: auto;
    max-height: 100%;
    margin: 0;
  }
</style>