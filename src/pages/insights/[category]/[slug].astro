---
import Layout from '../../../layouts/Layout.astro';
import BlogPostHero from '../../../components/sections/blog/blogPost/BlogPostHero.astro';
import BlogPostSidebar from '../../../components/sections/blog/blogPost/BlogPostSidebar.astro';
import BlogPostBody from '../../../components/sections/blog/blogPost/BlogPostBody.astro';
import BlogPostCTA from '../../../components/sections/blog/blogPost/BlogPostCTA.astro';
import { getBlogPosts, getRelatedBlogPosts } from '../../../utils/sanityClient';
import RelatedPosts from '../../../components/sections/blog/blogPost/RelatedPosts.astro';
import Form from '../../../components/sections/global/Form.astro';

interface Props {
	data: any;
  allPosts: any;
}

export const prerender = true;

export async function getStaticPaths() {

  const posts = await getBlogPosts();

  return posts.map((post) => {
    return {
      params: { slug: post.slug.current, category: post.category.slug.current },
      props: { data: post, allPosts: posts.filter(otherPost => otherPost.slug.current != post.slug.current ) }
    }
  })
}

const { slug, category } = Astro.params;
const { data, allPosts } = Astro.props;

const relatedPosts = await getRelatedBlogPosts(data)
console.log(data)
---

<Layout 
    title="Insights"
    theme="light"
>
    <BlogPostHero
      title={data.title}
      excerpt={data.excerpt}
      image={data.mainImage}
      imageAlt={data.imageAlt}
      category={data.category}
      authors={data.authors}
      date={data.publishedAt}
    />

    <div class="blog-post-content">
      <BlogPostBody
        content={data.content}
        authors={data.authors}
      />
      <BlogPostSidebar
        heading={data.sidebar && data.sidebar.heading ? data.sidebar.heading : data.category.callToAction.heading}
        subheading={data.sidebar && data.sidebar.subheading ? data.sidebar.subheading : data.category.callToAction.subheading}
        buttonText={data.sidebar && data.sidebar.buttonText ? data.sidebar.buttonText : data.category.callToAction.buttonText}
        buttonUrl={data.sidebar && data.sidebar.buttonUrl ? data.sidebar.buttonUrl : data.category.callToAction.buttonUrl}
        posts={allPosts}
        category={data.category}
      />
    </div>

    {data.callToAction && data.callToAction.heading && data.callToAction.buttonText && data.callToAction.buttonUrl ? 
      <BlogPostCTA
        heading={data.callToAction.heading}
        subheading={data.callToAction.subheading}
        buttonText={data.callToAction.buttonText}
        buttonUrl={data.callToAction.buttonUrl}
      />
    : null }

    {!data.formOverride || !data.formOverride.hideForm ? 
      <Form 
        heading={data.category.contactFormHeading}
        text={data.category.contactFormText}
        hubspotFormId={data.category.hubspotFormId}
      />
    : null }

    <RelatedPosts
      posts={relatedPosts}
    />

</Layout>

<!-- <style>
  document.addEventListener("astro:page-load", () => {
    window.scrollTo(0, 0);
  })
</style> -->

<style>

  .blog-post-content {
    display: flex;
    flex-direction: row;
    justify-content: stretch;
    align-items: flex-start;
    gap: var(--space-3xl);
    padding: var(--space-3xl) var(--page-margin);
  }

  @media screen and (max-width:768px) {
    .blog-post-content {
    padding: var(--space-lg) var(--page-margin);
      flex-direction: column;
    }
  }

</style>
